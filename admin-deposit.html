<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>üí∞ Admin Deposit ‚Äì Kwabenamedia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:0;}
    header{background:#004aad;color:white;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    header h2{margin:0;font-weight:600;}
    header span{font-size:14px;color:#e0e0e0;}
    .container{display:flex;}
    nav{width:230px;background:#003366;color:#fff;min-height:100vh;padding-top:25px;}
    nav h3{text-align:center;margin-bottom:20px;}
    nav a{display:block;color:#fff;text-decoration:none;padding:12px 20px;border-left:4px solid transparent;transition:0.3s;font-weight:500;}
    nav a:hover,nav a.active{background:#0055aa;border-left-color:#fff;}
    main{flex:1;padding:25px;}
    h3{color:#004aad;}
    .form-container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);max-width:600px;margin-bottom:30px;}
    label{font-weight:600;display:block;margin-top:10px;color:#333;}
    input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:6px;font-size:15px;}
    button{padding:10px 16px;border:none;border-radius:6px;color:white;font-weight:600;cursor:pointer;}
    .submitBtn{background:#004aad;width:100%;margin-top:15px;}
    .submitBtn:hover{background:#003b88;}
    table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,0.05);border-radius:8px;overflow:hidden;}
    th,td{border:1px solid #eee;padding:12px;text-align:left;font-size:15px;}
    th{background:#004aad;color:white;}
    tr:nth-child(even){background:#f9f9f9;}
    tr:hover{background:#eef5ff;transition:0.3s;}
    .delete-btn{background:#dc3545;padding:8px 12px;border:none;border-radius:5px;color:#fff;cursor:pointer;}
    .delete-btn:hover{background:#b52a37;}
    .action-btn{background:#007bff;padding:8px 12px;border:none;border-radius:5px;color:#fff;cursor:pointer;}
    .action-btn:hover{background:#005ec2;}
    .status{padding:5px 10px;border-radius:5px;color:#fff;font-weight:bold;text-transform:capitalize;}
    .Approved{background:#28a745;}
    .Pending{background:#ff9800;}
    .Rejected{background:#dc3545;}
    @media(max-width:768px){
      nav{width:100%;display:flex;overflow-x:auto;}
      nav a{flex:1;text-align:center;font-size:14px;}
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <header>
    <h2>üí∞ Admin Deposit</h2>
    <span id="datetime"></span>
  </header>

  <div class="container">
    <nav>
      <h3>Kwabenamedia</h3>
      <a href="admin-dashboard.html">üìä Overview</a>
      <a href="admin-users.html">üë• Users</a>
      <a href="admin-orders.html">üõí Orders</a>
      <a href="admin-deposit.html" class="active">üí≥ Deposits</a>
      <a href="admin-services.html">‚öôÔ∏è Services</a>
      <a href="#" class="logout" onclick="logout()">üö™ Logout</a>
    </nav>

    <main>
      <h3>Add Funds to User Wallet</h3>
      <div class="form-container">
        <label>User UID</label>
        <input type="text" id="userUID" placeholder="Enter user UID">

        <label>Amount (USD)</label>
        <input type="number" id="depositAmount" placeholder="Enter amount in USD" min="1">

        <label>Payment Method</label>
        <select id="paymentMethod">
          <option value="Mobile Money">Mobile Money</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Cash">Cash</option>
        </select>

        <button class="submitBtn" id="depositBtn">Credit Account</button>
      </div>

      <!-- ‚úÖ Deduction Section -->
      <h3>Deduct Funds from User Wallet</h3>
      <div class="form-container">
        <label>User UID</label>
        <input type="text" id="deductUID" placeholder="Enter user UID">

        <label>Amount (USD)</label>
        <input type="number" id="deductAmount" placeholder="Enter amount to deduct" min="1">

        <button class="submitBtn" id="deductBtn" style="background:#dc3545;">Deduct Amount</button>
      </div>

      <h3>üìã Deposit History</h3>
      <table id="depositTable">
        <thead>
          <tr>
            <th>#</th>
            <th>UID</th>
            <th>Amount (USD)</th>
            <th>Method</th>
            <th>Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="depositBody"><tr><td colspan="7" style="text-align:center;">Loading...</td></tr></tbody>
      </table>
    </main>
  </div>

  <script>
    // ‚úÖ Firebase config
    const firebaseConfig={
      apiKey:"AIzaSyCGoDeUIKI_aWPV-Ys6Swlw9YQNcVhn5dY",
      authDomain:"kwabenamedia.firebaseapp.com",
      databaseURL:"https://kwabenamedia-default-rtdb.firebaseio.com",
      projectId:"kwabenamedia",
      storageBucket:"kwabenamedia.appspot.com",
      messagingSenderId:"508812066118",
      appId:"1:508812066118:web:5bf0b2f7f7844d05b3b947"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();
    const firestore=firebase.firestore();
    const auth=firebase.auth();

    const depositBtn=document.getElementById("depositBtn");
    const deductBtn=document.getElementById("deductBtn");
    const depositBody=document.getElementById("depositBody");

    // ‚úÖ Add deposit manually
    depositBtn.addEventListener("click",async()=>{
      const uid=document.getElementById("userUID").value.trim();
      const amount=parseFloat(document.getElementById("depositAmount").value);
      const method=document.getElementById("paymentMethod").value;

      if(!uid||!amount||amount<=0){alert("‚ö†Ô∏è Enter a valid UID and amount.");return;}
      if(!confirm(`Are you sure you want to credit UID: ${uid} with $${amount}?`))return;

      try{
        const userRef=db.ref("users/"+uid);
        const userSnap=await userRef.once("value");
        if(!userSnap.exists()){alert("‚ùå UID not found.");return;}

        const balanceRef=db.ref(`users/${uid}/balance`);
        const balSnap=await balanceRef.once("value");
        const oldBal=parseFloat(balSnap.val())||0;
        const newBal=oldBal+amount;
        await balanceRef.set(newBal);
        await firestore.collection("users").doc(uid).set({balance:newBal},{merge:true});

        await db.ref(`deposits/${uid}`).push({
          uid,amountUSD:amount,method,
          date:new Date().toLocaleString(),
          status:"Approved"
        });

        alert(`‚úÖ UID: ${uid} credited with $${amount}.`);
        loadDeposits();
      }catch(err){alert("‚ùå Error: "+err.message);}
    });

    // ‚úÖ Deduct funds
    deductBtn.addEventListener("click",async()=>{
      const uid=document.getElementById("deductUID").value.trim();
      const amount=parseFloat(document.getElementById("deductAmount").value);

      if(!uid||!amount||amount<=0){alert("‚ö†Ô∏è Enter valid UID and amount.");return;}
      if(!confirm(`Are you sure you want to deduct $${amount} from UID: ${uid}?`))return;

      try{
        const balanceRef=db.ref(`users/${uid}/balance`);
        const balSnap=await balanceRef.once("value");
        const oldBal=parseFloat(balSnap.val())||0;
        if(oldBal<amount){alert("‚ùå Insufficient balance.");return;}

        const newBal=oldBal-amount;
        await balanceRef.set(newBal);
        await firestore.collection("users").doc(uid).set({balance:newBal},{merge:true});

        await db.ref(`deposits/${uid}`).push({
          uid,amountUSD:-amount,method:"Deduction",
          date:new Date().toLocaleString(),
          status:"Approved"
        });

        alert(`‚úÖ $${amount} deducted from UID: ${uid}.`);
        loadDeposits();
      }catch(err){alert("‚ùå Error: "+err.message);}
    });

    // ‚úÖ Load deposits
    function loadDeposits(){
      db.ref("deposits").on("value",snap=>{
        depositBody.innerHTML="";
        let count=0;
        snap.forEach(userSnap=>{
          userSnap.forEach(dep=>{
            const d=dep.val();
            const uid=userSnap.key;
            depositBody.innerHTML+=`
              <tr>
                <td>${++count}</td>
                <td>${uid}</td>
                <td>${parseFloat(d.amountUSD||0)>=0?"$"+parseFloat(d.amountUSD).toFixed(2):"-$"+Math.abs(d.amountUSD).toFixed(2)}</td>
                <td>${d.method||"-"}</td>
                <td>${d.date||"-"}</td>
                <td><span class="status ${d.status||'Pending'}">${d.status||'Pending'}</span></td>
                <td>
                  <button class="action-btn" onclick="changeStatus('${uid}','${dep.key}','${d.status||'Pending'}')">Change</button>
                  <button class="delete-btn" onclick="deleteDeposit('${uid}','${dep.key}')">üóë</button>
                </td>
              </tr>`;
          });
        });
        if(count===0)depositBody.innerHTML=`<tr><td colspan="7" style="text-align:center;">No deposits yet</td></tr>`;
      });
    }

    function changeStatus(uid,depKey,currentStatus){
      const newStatus=prompt("Enter new status (Pending / Approved / Rejected):",currentStatus);
      if(!newStatus)return;
      if(!["Pending","Approved","Rejected"].includes(newStatus)){
        alert("Invalid status.");return;
      }
      db.ref(`deposits/${uid}/${depKey}/status`).set(newStatus)
      .then(()=>alert(`‚úÖ Status updated.`))
      .catch(err=>alert("‚ùå "+err.message));
    }

    function deleteDeposit(uid,depKey){
      if(confirm("Delete this deposit?")){
        db.ref(`deposits/${uid}/${depKey}`).remove()
        .then(()=>alert("üóë Deleted."))
        .catch(err=>alert("Error: "+err.message));
      }
    }

    function logout(){auth.signOut();localStorage.clear();window.location.href="login.html";}
    function updateDateTime(){document.getElementById("datetime").textContent=new Date().toLocaleString();}
    setInterval(updateDateTime,1000);
    updateDateTime();
    loadDeposits();
  </script>
</body>
</html>