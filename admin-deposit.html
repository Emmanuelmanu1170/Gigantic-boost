<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Deposit ‚Äì Kwabenamedia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:0;}
    header{background:#004aad;color:white;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    header h2{margin:0;font-weight:600;}

    main{padding:25px;}
    .card{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);max-width:500px;margin:auto;}
    input,button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;font-size:15px;}
    input{background:#f1f3f6;}
    button{background:#004aad;color:white;font-weight:600;cursor:pointer;}
    button:hover{background:#003080;}
    .balance{margin-top:10px;font-weight:600;color:#004aad;text-align:center;}
    .success{color:green;text-align:center;margin-top:10px;}
    .error{color:red;text-align:center;margin-top:10px;}
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h2>üí∞ Admin Deposit & Deduction</h2>
    <button onclick="window.location.href='admin-dashboard.html'" style="background:#ffa500;padding:8px 14px;border:none;border-radius:8px;color:#fff;font-weight:600;">‚¨Ö Back</button>
  </header>

  <main>
    <div class="card">
      <h3>üîç Find User & Adjust Balance</h3>
      <input type="email" id="email" placeholder="Enter user email" required>
      <button onclick="findUser()">Search User</button>

      <div class="balance" id="balanceDisplay"></div>

      <div id="adjustSection" style="display:none;">
        <input type="number" id="amount" placeholder="Enter amount to subtract" min="0">
        <button onclick="subtractFunds()">‚ûñ Subtract Funds</button>
        <div id="msg"></div>
      </div>
    </div>
  </main>

  <script>
    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey:"AIzaSyCGoDeUIKI_aWPV-Ys6Swlw9YQNcVhn5dY",
      authDomain:"kwabenamedia.firebaseapp.com",
      databaseURL:"https://kwabenamedia-default-rtdb.firebaseio.com",
      projectId:"kwabenamedia",
      storageBucket:"kwabenamedia.appspot.com",
      messagingSenderId:"508812066118",
      appId:"1:508812066118:web:5bf0b2f7f7844d05b3b947"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let foundUserKey = null;
    let currentBalance = 0;

    function findUser(){
      const email = document.getElementById("email").value.trim().toLowerCase();
      if(!email){alert("Enter user email");return;}

      db.ref("users").once("value").then(snap=>{
        let found = false;
        snap.forEach(child=>{
          const data = child.val();
          if(data.email && data.email.toLowerCase() === email){
            foundUserKey = child.key;
            currentBalance = parseFloat(data.balance || 0);
            document.getElementById("balanceDisplay").textContent = "Current Balance: $" + currentBalance.toFixed(2);
            document.getElementById("adjustSection").style.display = "block";
            document.getElementById("msg").textContent = "";
            found = true;
          }
        });
        if(!found){
          document.getElementById("balanceDisplay").textContent = "‚ùå User not found.";
          document.getElementById("adjustSection").style.display = "none";
        }
      });
    }

    function subtractFunds(){
      const amount = parseFloat(document.getElementById("amount").value);
      if(isNaN(amount) || amount <= 0){alert("Enter a valid amount.");return;}
      if(foundUserKey === null){alert("Find a user first.");return;}
      if(amount > currentBalance){alert("‚ùå Cannot subtract more than available balance.");return;}

      const newBalance = currentBalance - amount;
      db.ref("users/"+foundUserKey+"/balance").set(newBalance)
      .then(()=>{
        document.getElementById("msg").innerHTML = "<p class='success'>‚úÖ Funds successfully subtracted!</p>";
        document.getElementById("balanceDisplay").textContent = "New Balance: $" + newBalance.toFixed(2);
      })
      .catch(err=>{
        document.getElementById("msg").innerHTML = "<p class='error'>‚ùå Error: " + err.message + "</p>";
      });
    }
  </script>
</body>
</html>