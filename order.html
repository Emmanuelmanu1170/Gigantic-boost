<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kwabenamedia — Place Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f3f5f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      background: #fff;
      padding: 25px;
      margin: 40px auto;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    label { font-weight: 600; display: block; margin-top: 15px; }
    select, input {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
    }
    button {
      width: 100%; margin-top: 20px; padding: 12px;
      background: #00994d; color: white; font-weight: 600;
      border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background: #007a3d; }
    .price-box { margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
    .balance { font-weight: 600; color: #00994d; }
  </style>
</head>
<body>
  <div class="container">
    <h2>📋 Place Your Order</h2>

    <label>Platform</label>
    <select id="platform">
      <option value="">-- Select Platform --</option>
    </select>

    <label>Service</label>
    <select id="service">
      <option value="">-- Select Service --</option>
    </select>

    <label>Quantity (Per 1000)</label>
    <input type="number" id="quantity" value="200" min="200">

    <div class="price-box">
      <p><strong>Price in USD:</strong> $<span id="priceUSD">0</span></p>
      <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
        <p class="balance">Balance: $<span id="balanceValue">0.00</span></p>
        <button id="refreshBalance" style="width:auto;">🔄 Refresh</button>
      </div>
    </div>

    <label>Username / Link</label>
    <input type="text" id="username" placeholder="Enter username or post link" required>

    <label>Email</label>
    <input type="email" id="email" placeholder="you@example.com" required>

    <label>Phone</label>
    <input type="text" id="phone" placeholder="e.g. +233xxxxxxxxx" required>

    <button id="placeBtn">Place Order</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGoDeUIKI_aWPV-Ys6Swlw9YQNcVhn5dY",
      authDomain: "kwabenamedia.firebaseapp.com",
      databaseURL: "https://kwabenamedia-default-rtdb.firebaseio.com",
      projectId: "kwabenamedia",
      storageBucket: "kwabenamedia.firebasestorage.app",
      messagingSenderId: "508812066118",
      appId: "1:508812066118:web:5bf0b2f7f7844d05b3b947",
      measurementId: "G-FWT4S09Z9L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const servicesData = {
      TikTok: {
        "Followers (Refill 20 days)": { id: 18236, price: 3.7 },
        "Followers (Non Drop)": { id: 10135, price: 5.7 },
        "Likes (Refill 20 days)": { id: 13088, price: 0.9 },
        "Likes (Non Drop | Super Instant)": { id: 4949, price: 2 },
        "Views": { id: 17776, price: 0.9 },
        "Views (Super Instant)": { id: 11183, price: 1.1 },
        "Shares": { id: 11105, price: 1 }
      },
      Instagram: {
        "Followers (Real Accounts)": { id: 27270, price: 7 },
        "Likes (Non Drop)": { id: 27295, price: 1 },
        "Views (Non Drop)": { id: 11184, price: 1.5 }
      },
      YouTube: {
        "Views (Non Drop)": { id: 24978, price: 4.8 },
        "Likes (Lifetime Guaranteed)": { id: 1865, price: 2 },
        "Subscribers (Lifetime Guaranteed)": { id: 18274, price: 65 }
      },
      Telegram: {
        "Members (Non Drop)": { id: 15521, price: 4 },
        "Reactions": { id: 19003, price: 2 },
        "Views": { id: 15982, price: 3 }
      },
      Facebook: {
        "Followers (Lifetime Guaranteed)": { id: 22328, price: 4 },
        "Likes (Instant | Non Drop | Lifetime Guaranteed)": { id: 10372, price: 8 },
        "Likes": { id: 10036, price: 3 },
        "Views (Monetizable)": { id: 16611, price: 2 }
      },
      WhatsApp: { "Channel Members": { id: 18706, price: 13 } },
      LinkedIn: { "AI Growth": { id: 20944, price: 100 } },
      Twitter: {
        "Followers (Non Drop)": { id: 16269, price: 20 },
        "Views": { id: 3775, price: 1 },
        "Likes": { id: 10864, price: 1.2 }
      }
    };

    const platformSelect = document.getElementById("platform");
    const serviceSelect = document.getElementById("service");
    const quantityInput = document.getElementById("quantity");
    const priceUSD = document.getElementById("priceUSD");
    const balanceValue = document.getElementById("balanceValue");
    const refreshBalance = document.getElementById("refreshBalance");
    const placeBtn = document.getElementById("placeBtn");

    Object.keys(servicesData).forEach(platform => {
      const opt = document.createElement("option");
      opt.value = platform;
      opt.textContent = platform;
      platformSelect.appendChild(opt);
    });

    platformSelect.addEventListener("change", () => {
      serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
      const services = servicesData[platformSelect.value];
      if (services) {
        Object.keys(services).forEach(service => {
          const opt = document.createElement("option");
          opt.value = service;
          opt.textContent = `${service} - $${services[service].price}`;
          serviceSelect.appendChild(opt);
        });
      }
    });

    serviceSelect.addEventListener("change", updatePrice);
    quantityInput.addEventListener("input", updatePrice);

    function updatePrice() {
      const platform = platformSelect.value;
      const service = serviceSelect.value;
      const qty = Number(quantityInput.value);
      if (!platform || !service || !qty) return;
      const serviceData = servicesData[platform][service];
      const total = (qty / 1000) * serviceData.price;
      priceUSD.textContent = total.toFixed(2);
    }

    let currentUID = null;
    let currentBalance = 0;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUID = user.uid;
        fetchBalance();
      } else {
        alert("You must be logged in to place an order.");
        window.location.href = "login.html";
      }
    });

    async function fetchBalance() {
      const snapshot = await get(ref(db, `users/${currentUID}/balance`));
      if (snapshot.exists()) {
        currentBalance = snapshot.val();
        balanceValue.textContent = currentBalance.toFixed(2);
      } else {
        currentBalance = 0;
        balanceValue.textContent = "0.00";
      }
    }

    refreshBalance.addEventListener("click", fetchBalance);

    placeBtn.addEventListener("click", async () => {
      const platform = platformSelect.value;
      const service = serviceSelect.value;
      const qty = Number(quantityInput.value);
      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (!platform || !service || !qty || !username || !email || !phone) {
        alert("Please fill in all required fields.");
        return;
      }

      const serviceData = servicesData[platform][service];
      const totalCost = (qty / 1000) * serviceData.price;

      if (currentBalance < totalCost) {
        alert("Insufficient balance. Please add funds.");
        return;
      }

      const orderData = {
        platform,
        service,
        qty,
        username,
        email,
        phone,
        totalCost: totalCost.toFixed(2), // ✅ FIXED: real total value saved
        date: new Date().toLocaleString(),
        status: "Pending"
      };

      try {
        const userOrderRef = ref(db, `orders/${currentUID}`);
        await push(userOrderRef, orderData);

        const adminOrderRef = ref(db, "adminOrders");
        await push(adminOrderRef, { ...orderData, user: currentUID });

        const newBalance = currentBalance - totalCost;
        await update(ref(db, `users/${currentUID}`), { balance: newBalance });
        currentBalance = newBalance;
        balanceValue.textContent = currentBalance.toFixed(2);

        alert("✅ Order placed successfully!");
        window.location.href = "order-history.html";
      } catch (error) {
        console.error(error);
        alert("❌ Failed to place order. Try again.");
      }
    });
  </script>
</body>
</html>