<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order History - Kwabenamedia</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: url('https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg') no-repeat center center fixed;
      background-size: cover;
      margin: 0; padding: 0; color: #222;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: -1;
    }
    .container {
      max-width: 1100px; margin: 40px auto;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
      border-radius: 20px; padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 { text-align: center; color: #008037; margin-bottom: 25px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #008037; color: #fff; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .btn-back {
      display: inline-block; padding: 12px 22px; margin-bottom: 15px;
      border-radius: 12px; text-decoration: none; background: #007bff;
      color: #fff; font-weight: 600; transition: 0.3s;
    }
    .btn-back:hover { background: #0056b3; transform: translateY(-2px) scale(1.05); }
    .delete-btn, .status-btn {
      border: none; border-radius: 6px; padding: 6px 12px;
      cursor: pointer; font-weight: 600; margin-right: 5px;
    }
    .delete-btn { background: #dc3545; color: #fff; }
    .delete-btn:hover { background: #b32b36; }
    .status-btn { background: #008037; color: #fff; }
    .status-btn:hover { background: #00682d; }
    .load-more {
      display: block; margin: 20px auto 0; padding: 10px 18px;
      background: #008037; color: #fff; border: none;
      border-radius: 8px; font-weight: 600; cursor: pointer;
      transition: 0.3s;
    }
    .load-more:hover { background: #00682d; transform: scale(1.05); }
    @media (max-width: 768px) {
      th, td { font-size: 14px; padding: 10px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="order.html" class="btn-back">‚¨ÖÔ∏è Back to Order Page</a>
    <h1>Your Order History</h1>
    <table id="orderHistoryTable">
      <thead>
        <tr>
          <th>#</th>
          <th>User Email</th>
          <th>Platform</th>
          <th>Service</th>
          <th>Quantity</th>
          <th>Total ($)</th>
          <th>Username / Link</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="10" style="text-align:center;">Loading orders...</td></tr>
      </tbody>
    </table>
    <button id="loadMoreBtn" class="load-more" style="display:none;">‚¨áÔ∏è Load More</button>
  </div>

  <!-- ‚úÖ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCGoDeUIKI_aWPV-Ys6Swlw9YQNcVhn5dY",
      authDomain: "kwabenamedia.firebaseapp.com",
      databaseURL: "https://kwabenamedia-default-rtdb.firebaseio.com",
      projectId: "kwabenamedia",
      storageBucket: "kwabenamedia.firebasestorage.app",
      messagingSenderId: "508812066118",
      appId: "1:508812066118:web:5bf0b2f7f7844d05b3b947"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const functions = firebase.functions();

    const tbody = document.querySelector('#orderHistoryTable tbody');
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    let allOrders = [];
    let displayedCount = 0;
    const PAGE_SIZE = 20;
    let currentUser = null;

    // ‚úÖ Listen for user login
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        if (user.email === "admin@google.com" || user.email === "admin@gmail.com") {
          loadAllOrdersLive();
        } else {
          loadUserOrdersLive(user.uid);
        }
      } else {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Please log in to view your orders.</td></tr>`;
      }
    });

    // ‚úÖ Admin: Live load all orders (users + adminOrders)
    function loadAllOrdersLive() {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Loading all orders...</td></tr>`;
      const allRefs = [db.ref("orders"), db.ref("adminOrders")];
      allOrders = [];

      allRefs.forEach(ref => {
        ref.on("value", snapshot => {
          allOrders = [];
          snapshot.forEach(parent => {
            if (ref.key === "orders") {
              parent.forEach(orderSnap => {
                allOrders.push({ id: orderSnap.key, uid: parent.key, ...orderSnap.val() });
              });
            } else {
              allOrders.push({ id: parent.key, uid: "admin", ...parent.val() });
            }
          });
          renderOrders();
        });
      });
    }

    // ‚úÖ User: Live load personal orders
    function loadUserOrdersLive(uid) {
      const ref = db.ref(`orders/${uid}`);
      ref.on("value", snapshot => {
        allOrders = [];
        snapshot.forEach(orderSnap => {
          allOrders.push({ id: orderSnap.key, uid, ...orderSnap.val() });
        });
        renderOrders();
      });
    }

    // ‚úÖ Render orders
    function renderOrders() {
      if (allOrders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No orders found.</td></tr>`;
        return;
      }

      allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
      tbody.innerHTML = "";
      let count = 0;

      allOrders.forEach(order => {
        count++;
        const colorMap = {
          Completed: "green",
          Processing: "orange",
          Cancelled: "red",
          Pending: "#555"
        };
        const color = colorMap[order.status] || "#555";
        const total = parseFloat(order.totalCost || 0);

        let actionBtns = "";
        if (currentUser.email === "admin@google.com" || currentUser.email === "admin@gmail.com") {
          actionBtns = `
            <button class="status-btn" onclick="updateStatus('${order.uid}','${order.id}','Completed')">‚úÖ Done</button>
            <button class="status-btn" onclick="updateStatus('${order.uid}','${order.id}','Processing')">‚öôÔ∏è Processing</button>
            <button class="status-btn" onclick="updateStatus('${order.uid}','${order.id}','Cancelled')">‚ùå Cancel</button>
            <button class="delete-btn" onclick="deleteOrder('${order.uid}','${order.id}','${order.reference || ''}')">üóë</button>`;
        } else {
          actionBtns = `<button class="delete-btn" onclick="deleteOrder('${order.uid}','${order.id}','${order.reference || ''}')">üóë</button>`;
        }

        tbody.innerHTML += `
          <tr>
            <td>${count}</td>
            <td>${order.email || "User"}</td>
            <td>${order.platform || "-"}</td>
            <td>${order.service || "-"}</td>
            <td>${order.qty || 0}</td>
            <td>$${total.toFixed(2)}</td>
            <td>${order.username || "-"}</td>
            <td><span style="color:${color};font-weight:600;">${order.status || "Pending"}</span></td>
            <td>${order.date || "-"}</td>
            <td>${actionBtns}</td>
          </tr>`;
      });
    }

    // ‚úÖ Update Order Status
    async function updateStatus(uid, orderId, status) {
      try {
        await db.ref(`orders/${uid}/${orderId}/status`).set(status);
        await db.ref(`adminOrders/${orderId}/status`).set(status);
        alert(`‚úÖ Status updated to ${status}`);
      } catch (err) {
        alert("‚ùå Error updating status: " + err.message);
      }
    }

    // ‚úÖ Delete Order (Admin or User)
    async function deleteOrder(uid, orderId, reference) {
      if (!confirm("Are you sure you want to delete this order?")) return;
      try {
        await db.ref(`orders/${uid}/${orderId}`).remove();
        await db.ref(`adminOrders/${orderId}`).remove();

        const logDelete = firebase.functions().httpsCallable("logOrderDeletion");
        await logDelete({ uid, orderId, reference });

        alert("‚úÖ Order deleted successfully!");
      } catch (err) {
        alert("‚ùå Error deleting order: " + err.message);
      }
    }
  </script>
</body>
</html>