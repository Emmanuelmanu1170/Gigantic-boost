<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order History - Kwabenamedia</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: url('https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg') no-repeat center center fixed;
      background-size: cover;
      margin: 0; padding: 0; color: #222;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: -1;
    }
    .container {
      max-width: 1100px; margin: 40px auto;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
      border-radius: 20px; padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 { text-align: center; color: #008037; margin-bottom: 25px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      padding: 12px 10px; border: 1px solid #ccc; text-align: left;
    }
    th { background-color: #008037; color: #fff; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .btn-back {
      display: inline-block; padding: 12px 22px; margin-bottom: 15px;
      border-radius: 12px; text-decoration: none; background: #007bff;
      color: #fff; font-weight: 600; transition: 0.3s;
    }
    .btn-back:hover { background: #0056b3; transform: translateY(-2px) scale(1.05); }
    .delete-btn {
      background: #dc3545; color: white; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-weight: 600;
    }
    .delete-btn:hover { background: #b32b36; }
    .load-more {
      display: block;
      margin: 20px auto 0;
      padding: 10px 18px;
      background: #008037;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    .load-more:hover {
      background: #00682d;
      transform: scale(1.05);
    }
    @media (max-width: 768px) {
      th, td { font-size: 14px; padding: 10px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="order.html" class="btn-back">‚¨ÖÔ∏è Back to Order Page</a>
    <h1>Your Order History</h1>
    <table id="orderHistoryTable">
      <thead>
        <tr>
          <th>#</th>
          <th>User Email</th>
          <th>Platform</th>
          <th>Service</th>
          <th>Quantity</th>
          <th>Total ($)</th>
          <th>Username / Link</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="10" style="text-align:center;">Loading orders...</td></tr>
      </tbody>
    </table>
    <button id="loadMoreBtn" class="load-more" style="display:none;">‚¨áÔ∏è Load More</button>
  </div>

  <!-- ‚úÖ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCGoDeUIKI_aWPV-Ys6Swlw9YQNcVhn5dY",
      authDomain: "kwabenamedia.firebaseapp.com",
      databaseURL: "https://kwabenamedia-default-rtdb.firebaseio.com",
      projectId: "kwabenamedia",
      storageBucket: "kwabenamedia.firebasestorage.app",
      messagingSenderId: "508812066118",
      appId: "1:508812066118:web:5bf0b2f7f7844d05b3b947"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const functions = firebase.functions();

    const tbody = document.querySelector('#orderHistoryTable tbody');
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    let allOrders = [];
    let displayedCount = 0;
    const PAGE_SIZE = 15;

    // ‚úÖ Auth Check
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email === "admin@google.com" || user.email === "admin@gmail.com") {
          loadAllOrdersForAdmin();
        } else {
          loadUserOrders(user.uid);
        }
      } else {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Please log in to view your orders.</td></tr>`;
      }
    });

    // ‚úÖ Admin: Load ALL users' orders
    function loadAllOrdersForAdmin() {
      const ordersRef = db.ref("orders");
      ordersRef.once("value").then(snapshot => {
        allOrders = [];

        snapshot.forEach(userSnap => {
          userSnap.forEach(orderSnap => {
            const orderData = orderSnap.val();
            allOrders.push({
              id: orderSnap.key,
              uid: userSnap.key,
              ...orderData
            });
          });
        });

        if (allOrders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No orders found.</td></tr>`;
          return;
        }

        allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
        displayedCount = 0;
        displayNextBatch();
      });
    }

    // ‚úÖ Normal user orders
    function loadUserOrders(uid) {
      const ordersRef = db.ref(`orders/${uid}`);
      ordersRef.once("value").then(snapshot => {
        allOrders = [];

        snapshot.forEach(child => {
          const data = child.val();
          allOrders.push({
            id: child.key,
            uid,
            ...data
          });
        });

        if (allOrders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No orders found.</td></tr>`;
          return;
        }

        allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
        displayedCount = 0;
        displayNextBatch();
      });
    }

    // ‚úÖ Display in batches
    function displayNextBatch() {
      const slice = allOrders.slice(displayedCount, displayedCount + PAGE_SIZE);
      if (displayedCount === 0) tbody.innerHTML = "";
      let count = displayedCount;

      slice.forEach(order => {
        count++;
        const colorMap = {
          Completed: "green",
          Processing: "orange",
          Cancelled: "red",
          Pending: "#555"
        };
        const color = colorMap[order.status] || "#555";
        const total = parseFloat(order.totalCost || 0);

        const row = `
          <tr>
            <td>${count}</td>
            <td>${order.email || "User"}</td>
            <td>${order.platform || "-"}</td>
            <td>${order.service || "-"}</td>
            <td>${order.qty || 0}</td>
            <td>$${total.toFixed(2)}</td>
            <td>${order.username || "-"}</td>
            <td><span style="color:${color};font-weight:600;">${order.status || "Pending"}</span></td>
            <td>${order.date || "-"}</td>
            <td>
              <button class="delete-btn" onclick="deleteOrder('${order.uid}','${order.id}','${order.reference || ''}')">üóë Delete</button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      displayedCount += slice.length;
      loadMoreBtn.style.display = displayedCount < allOrders.length ? "block" : "none";
    }

    // ‚úÖ Delete Order
    async function deleteOrder(uid, orderId, reference) {
      if (!confirm("Are you sure you want to delete this order?")) return;

      try {
        await db.ref(`orders/${uid}/${orderId}`).remove();

        if (reference) {
          const adminSnap = await db.ref("adminOrders").once("value");
          adminSnap.forEach(child => {
            const order = child.val();
            if (order.reference === reference) {
              db.ref("adminOrders/" + child.key).remove();
            }
          });
        }

        const logDelete = firebase.functions().httpsCallable("logOrderDeletion");
        await logDelete({ uid, orderId, reference });

        alert("‚úÖ Order deleted successfully!");
        loadAllOrdersForAdmin(); // refresh after delete
      } catch (err) {
        alert("‚ùå Error deleting order: " + err.message);
      }
    }

    loadMoreBtn.addEventListener("click", displayNextBatch);
  </script>
</body>
</html>